// version 1.1


// Тестировалось на Arduino IDE 1.0.1
#include <SPI.h>
#include "DHT.h" // подключаем библиотеку
#include <RFID.h>
#include <EEPROM.h>
#define SS_PIN 10
#define RST_PIN 9
#define DHTPIN 6
#define DHTTYPE DHT11
RFID rfid(SS_PIN, RST_PIN);
uint32_t myTimer1; //Таймер
uint32_t myTimer2 ; //Таймер
uint32_t myTimer3; //Таймер
uint32_t myTimer4 = 15000 ; //Таймер
int dinam = 3;
int serNum0;
int serNum1;
int klass[] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11}; //0,1,2,3,4,5,6,7,8,9,10,11,12
int ky[] = {0, 0}; //Утренние ученики
int pg[] {0, 0}; //Сбежавшие ученики
int kv[] = {0, 0};//Вечерние ученики
int KL;
int i[] {0, 0}; //Круг утренних карточек
int vx[] {0, 0};
int k1[]{0,0} ;//Количество утрнних  учеников
int k2[] {0,1}; //Количество вечерних учеников
int UID[] = {199, 89}; //Верные айди
int vg[] = {0, 0}; //Пропуски
int vg0;
int vg1;
int ky0;
int ky1;
int kv0;
int kv1;
const char *bykva[]  = {
  "А",   // 0
  "Б",     // 1
  "В",     // 2
};

String IM;
String BK;
String FAM;

DHT dht(DHTPIN, DHTTYPE);
void setup()
{
  Serial.begin(9600);
  dht.begin(); // запускаем датчик
  SPI.begin();
  rfid.init();
  Serial.read();
  vg0 = EEPROM.read(0);
  vg1 = EEPROM.read(1);


}


void loop()
{
  Serial.print("");

  // Если обнаружена карта
  {
    if (rfid.isCard()) {
      delay(500);

      // Считываем адрес
      if (rfid.readCardSerial()) {


        // Выводим его в порт в десятичном представлении
      }
    }
    rfid.halt();

  }

  if (rfid.serNum[0] == UID[0] and i[0] == 0) {
    while (rfid.serNum[0] == UID[0] and i[0] == 0) {
      FAM = "Демченко";
      IM = "Илья";
      KL = klass[9];
      BK = bykva[0];

      tone(dinam, 659, 300);
      Serial.println(" ");
      Serial.println("===========================================================================");
      Serial.println(" ");
      Serial.println("Пришел на объект:");
      Serial.print(FAM);
      Serial.print(" ");
      Serial.print(IM);
      Serial.print(" ");
      Serial.print(KL);
      Serial.println(BK);
      Serial.println("");
      Serial.println("");
      Serial.println("===========================================================================");

      rfid.serNum[0] = 0;
      rfid.serNum[1] = 100;
      i[0]++;
      ky[0]++;
      vx[0] = 1;
      if(k1[0]=0){
      k1[0]++;
      }
    }
  }



  if (rfid.serNum[0] == UID[1] and i[1] == 0 ) {
    while (rfid.serNum[0] == UID[1] and i[1] == 0) {
      FAM = "Петров" ;
      IM = "Василий";
      KL = klass[5];
      BK = bykva[1];
      Serial.println(" ");
      Serial.println("===========================================================================");
      Serial.println(" ");
      Serial.println("Пришел на объект:");
      Serial.print(FAM);
      Serial.print(" ");
      Serial.print(IM);
      Serial.print(" ");
      Serial.print(KL);
      Serial.println(BK);
      Serial.println("");
      Serial.println("");
      Serial.println("===========================================================================");
      tone(dinam, 784, 150);
      rfid.serNum[0] = 0;
      rfid.serNum[1] = 100;
      i[1]++;
      ky[1]++;
      vx[1] = 1;

    }

  }

  

   


    
  



  if (millis() - myTimer1 > 55505) {
    Serial.println("===========================================================================");
    Serial.println("УТРЕННИЙ ОТЧЕТ");
    Serial.println("УТРЕННИЙ ОТЧЕТ");
    Serial.println("УТРЕННИЙ ОТЧЕТ");


    float h = dht.readHumidity(); // считываем влажность
    float t = dht.readTemperature(); // считываем температуру


    if (t <= 20) {
      Serial.println("Низкая температура");
      tone(dinam, 512, 400);
    }
    if (t >= 30) {
      Serial.println("Высокая температура"); {
        tone(dinam, 1024, 800);
      }
    }
    if (h < 20) {
      Serial.println("Низкая влажность");
      tone(dinam, 2048, 800);
    }
    if (h > 65) {
      Serial.println("Высокая влажность");
      tone(dinam, 4048, 800);
    }

    // проверяем полученные значения
    if (isnan(h) || isnan(t)) {
      Serial.println("Ошибка чтения датчика");
      return;
    }


    // выводим полученные данные в консоль


    Serial.println(" ");
    Serial.println(" ");
    Serial.println("===========================================================================");


    Serial.println("===========================================================================");
    if (k1[0,1] > 0) {
      Serial.println("Всего учеников пришло:");
      Serial.print(k1[0+1]);
      Serial.println("");
      if (i[0] == 1) {
        Serial.println("Демченко Илья");
      }
      if (i[1] == 1) {
        Serial.println("Петров Василий");
      }
    }

    Serial.println("===========================================================================");

    if (i[0] == 0  or i[1] == 0 ) {
      Serial.println("Ученики, которые не пришли:");



    }
    if (serNum1 == 0  and i[0] == 0) {
      EEPROM.update(0, vg0 + 1);


      Serial.println("Демченко Илья");
      Serial.println("Дней пропущено:");
      Serial.println(EEPROM.read(0));
      vg0++;
      Serial.println("");
      Serial.println("===========================================================================");

    }


    if (serNum1 == 0  and i[1] == 0) {
      EEPROM.update(1, vg1 + 1);


      Serial.println("Петров Василий");
      Serial.println("Дней пропущено:");
      Serial.println(EEPROM.read(1));
      vg1++;
      Serial.println("");
      Serial.println("===========================================================================");

    }


    Serial.println("");
    Serial.print("Влажность : ");
    Serial.println(h);
    Serial.print("Температура: ");
    Serial.print(t);
    Serial.print(" *C, ");

    k1[0,1] = 0;
    i[0] = 0;
    i[1] = 0;
    myTimer1 = millis();
  }
  if (millis() - myTimer2 > 226505) {
    Serial.println("===========================================================================");
    Serial.println("ВЕЧЕРНИЙ ОТЧЕТ ");
    Serial.print("");
    Serial.println("Всего учеников ушло:");
    Serial.println(k2[0+1]);
    Serial.println("Ученики, которые ушли вовремя:");

    myTimer2 = millis();
    myTimer4 = millis();


  }
}








