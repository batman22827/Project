// version 1.1


// Тестировалось на Arduino IDE 1.0.1
#include <SPI.h>
#include "DHT.h" // подключаем библиотеку
#include <RFID.h>
#include <EEPROM.h>
#define SS_PIN 10
#define RST_PIN 9
#define DHTPIN 6
#define DHTTYPE DHT11
RFID rfid(SS_PIN, RST_PIN);
uint32_t myTimer1; //Таймер
uint32_t myTimer2; //Таймер отметки
int dinam = 3;
int serNum0;
char target[] = "reset";
int serNum1;
int pg[] {0, 0}; //Сбежавшие ученики
int k; // Утренние ученики, которые пришли
int vx[] {0, 0}; //Кол-во считываний для выхода из системы
int UID[] = {199, 89}; //Верные айди
int vg[] = {0, 0}; //Пропуски
int vg0;
int vg1;
const char *bykva[]  = {
  "А",   // 0
  "Б",     // 1
  "В",     // 2
};

const char *ych[] = {
  "Демченко Илья Евгеньевич 10 А",//0
  "Петров Василий Михайлович 6 Б ",//1
};


DHT dht(DHTPIN, DHTTYPE);
void setup()
{
  Serial.begin(9600);
  dht.begin(); // запускаем датчик
  SPI.begin();
  rfid.init();
  Serial.read();
  vg0 = EEPROM.read(0);
  vg1 = EEPROM.read(1);
}


void loop()
{
  Serial.print("");

  // Если обнаружена карта
  {
    if (rfid.isCard()) {
      delay(150);
      // Считываем адрес
      if (rfid.readCardSerial()) {


      }
      // Выводим его в порт в десятичном представлении
    }
  }
  rfid.halt();




  if (rfid.serNum[0] == UID[0] and vx[0] == 0 || rfid.serNum[0] == UID[1] and vx[1] == 0 ) {
    while (rfid.serNum[0] == UID[0] and vx[0] == 0 || rfid.serNum[0] == UID[1] and vx[1] == 0 ) {

      tone(dinam, 659, 300);
      Serial.println(" ");
      Serial.println("===========================================================================");
      Serial.println(" ");
      Serial.println("Занесен в систему");


      if (rfid.serNum[0] == UID[0] and vx[0] == 0) {
        while (rfid.serNum[0] == UID[0] and vx[0] == 0) {
          Serial.println(ych[0]);
          rfid.serNum[0] = 0;
          k++;
          vx[0]++;

        }
      }
      if (rfid.serNum[0] == UID[1] and vx[1] == 0) {
        while (rfid.serNum[0] == UID[1] and vx[1] == 0) {
          Serial.println(ych[1]);
          rfid.serNum[0] = 0;
          k++;
          vx[1]++;
        }
      }
      Serial.println("");
      Serial.println("");
      Serial.println("===========================================================================");
    }
  }
  if (rfid.serNum[0] == UID[0] and vx[0] == 1 ) {
    while (rfid.serNum[0] == UID[0] and vx[0] == 1 ) {
      tone(dinam, 212, 400);
      Serial.println("===========================================================================");
      Serial.println(ych[0]);
      Serial.println("");
      Serial.println("Желаете покинуть систему досрочно?");
      Serial.println("");
      Serial.println("Чтобы покинуть систему,");
      Serial.print("Приложите карту еще раз");
      Serial.println("");
      Serial.println("===========================================================================");
      rfid.serNum[0] = 0;
      vx[0]++;
      delay(900);
    }
  }



  if (rfid.serNum[0] == UID[1] and vx[1] == 1 ) {
    while (rfid.serNum[0] == UID[1] and vx[1] == 1 ) {
      tone(dinam, 212, 400);
      Serial.println("===========================================================================");
      Serial.println(ych[1]);
      Serial.println("");
      Serial.println("Желаете покинуть систему досрочно?");
      Serial.println("");
      Serial.print("");
      Serial.println("Чтобы покинуть систему,");
      Serial.print("Приложите карту еще раз");
      Serial.println("");
      Serial.println("===========================================================================");
      rfid.serNum[0] = 0;
      vx[1]++;
      delay(900);
      Serial.println("");
    }
  }
  if (rfid.serNum[0] == UID[0] and vx[0] == 2 ) {
    while (rfid.serNum[0] == UID[0] and vx[0] == 2 ) {
      tone(dinam, 412, 400);
      Serial.println("===========================================================================");
      Serial.println(ych[0]);
      Serial.println("");
      Serial.println("Покинул систему досрочно");
      Serial.println("===========================================================================");
      rfid.serNum[0] = 0;
      pg[0]++;
      vx[0]++;

    }
  }


  if (rfid.serNum[0] == UID[1] and vx[1] == 2 ) {
    while (rfid.serNum[0] == UID[1] and vx[1] == 2 ) {
      tone(dinam, 812, 400);
      Serial.println("===========================================================================");
      Serial.println(ych[1]);
      Serial.println("");
      Serial.println("Покинул систему досрочно");
      Serial.println("===========================================================================");
      rfid.serNum[0] = 0;
      pg[1]++;
      vx[1]++;

    }
  }



  if (rfid.serNum[0] == UID[0] and vx[0] > 2 or rfid.serNum[0] == UID[1] and vx[1] > 2) {
    while (rfid.serNum[0] == UID[0] and vx[0] > 2 or rfid.serNum[0] == UID[1] and vx[1] > 2) {
      Serial.println("===========================================================================");
      Serial.println("");
      if (vx[0] == 3) {
        Serial.println(ych[0]);
      }
      if (vx[1] == 3) {
        Serial.println(ych[1]);
      }
      Serial.println("Вы уже покинули систему");
      Serial.println("");
      Serial.println("===========================================================================");
      tone(dinam, 412, 400);
      rfid.serNum[0] = 0;
    }
  }
  if (millis() - myTimer2 > 25000 ) {
    if (vx[0] == 3 ) {
      while (vx[0] > 0 ) {
        Serial.println("Ученики, ушедшие из школы:");
        if (vx[0] > 0 ) {
          Serial.println(ych[0]);
          vx[0] = 0;
        }
        if (vx[1] > 0) {
          Serial.println(ych[1]);
        }
      }
    }
  }

















  if (millis() - myTimer1 > 55505) {
    Serial.println("===========================================================================");
    Serial.println("УТРЕННИЙ ОТЧЕТ");
    Serial.println("УТРЕННИЙ ОТЧЕТ");
    Serial.println("УТРЕННИЙ ОТЧЕТ");

    float h = dht.readHumidity(); // считываем влажность
    float t = dht.readTemperature(); // считываем температуру

    if (t <= 20) {
      Serial.println("Низкая температура");
      tone(dinam, 512, 400);
    }
    if (t >= 30) {
      Serial.println("Высокая температура"); {
        tone(dinam, 1024, 800);
      }
    }
    if (h < 20) {
      Serial.println("Низкая влажность");
      tone(dinam, 2048, 800);
    }
    if (h > 65) {
      Serial.println("Высокая влажность");
      tone(dinam, 4048, 800);
    }

    // проверяем полученные значения
    if (isnan(h) || isnan(t)) {
      Serial.println("Ошибка чтения датчика");
      return;
    }


    // выводим полученные данные в консоль




    Serial.println(" ");
    Serial.println(" ");
    Serial.println("===========================================================================");


    Serial.println("===========================================================================");
    Serial.println("");
    Serial.println("Ученики, которые пришли:");
    if (vx[0] > 0) {
      Serial.println(ych[0]);
    }
    if (vx[1] > 0) {
      Serial.println(ych[1]);
    }





    Serial.println("===========================================================================");

    if (vx[0] == 0  or vx[1] == 0 ) {
      Serial.println("Ученики, которые не пришли:");

      if (vx[0] == 0) {
        Serial.println(ych[0]);
      }
      if (vx[1] == 0) {
        Serial.println(ych[1]);
      }

      Serial.println("===========================================================================");

    }
    if (serNum1 == 0  and vx[0] == 0) {
      EEPROM.update(0, vg0 + 1);
      Serial.println("");
      Serial.println(ych[0]);
      Serial.println("Дней пропущено:");
      Serial.println(EEPROM.read(0));
      vg0++;
      Serial.println("");
      Serial.println("===========================================================================");

    }


    if (serNum1 == 0  and vx[1] == 0) {
      EEPROM.update(1, vg1 + 1);
      Serial.println(ych[1]);
      Serial.println("Дней пропущено:");
      Serial.println(EEPROM.read(1));
      vg1++;
      Serial.println("");
      Serial.println("===========================================================================");

    }


    Serial.println("");
    Serial.print("Влажность : ");
    Serial.println(h);
    Serial.print("Температура: ");
    Serial.print(t);
    Serial.print(" *C, ");

    vx[0] = 0;
    vx[1] = 0;

    myTimer1 = millis();
  }
   if (Serial.available() > 0) {
    if (Serial.find(target))
      Serial.println("Сброс пропусков");
      vg0 = 0;
      vg1 = 0;
    
  }
}    
    
  


